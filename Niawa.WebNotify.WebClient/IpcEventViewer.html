<!DOCTYPE html>
<html>
<head>
    <title>Niawa Notify - IPC Event Viewer</title>
    <link rel="stylesheet" href="IpcEventViewer.css" />
</head>
<body>
    <!--------------------->
    <!--HTML definitions -->
    <!--------------------->

    <div id="container">
        <div id="content" class="clearfix">
            <!--Navigation block-->
            <div id="nav">
                <div id="nav1" class="navblock">
                    <ul id="CurrentNodeList">
                        <li id="CurrentNodeListItem">(no item selected)</li>
                    </ul>
                </div>
                <div id="nav2" class="navblock">
                    <ul id="NodesList">
                        <li>(content not available)</li>
                        <!--Dynamic content-->

                    </ul>
                </div>
                <div id="nav3" class="navblock">
                    <!--<span id='status_1'>&nbsp;</span>-->
                    <!--Dynamic content-->

                </div>
            </div>
            <!--Main content block-->
            <div id="maincontent">
                <!--Persistent content-->
                <div class="contentblocktop" id="ThreadStatusBlock">
                    <p>
                        <b>Node:</b> <span id='tsb_ThreadName'></span><br />
                        <b>Status:</b> <span id='tsb_ThreadStatus'></span><br />
                        <b>Initialized Date:</b> <span id='tsb_InitializedDate'></span><br />
                        <b>Last Reported Date:</b> <span id='tsb_LastReportedDate'></span><br />
                        <b>Health Failed:</b> <span id='tsb_ThreadHealth'></span><br />
                        <b>Errors:</b> <span id='tsb_ErrorCount'></span><br />
                        <b>Messages Processed:</b> <span id='tsb_MessagesProcessedCount'></span><br />
                        <b>Message Errors:</b> <span id='tsb_MessageErrorsCount'></span><br />
                        <b>Node ID:</b> <span id='tsb_NodeID'></span><br />
                        <b>Parent Node ID:</b> <span id='tsb_ParentNodeID'></span><br />
                    </p>

                </div>
                <div class="contentblocktop" id="ThreadCustomBlock">
                    <p>
                        <div id="tcb_1" style="display:none"><b><span id='tcb_1k'></span>:</b> <span id='tcb_1v'></span></div><br />
                        <div id="tcb_2" style="display:none"><b><span id='tcb_2k'></span>:</b> <span id='tcb_2v'></span></div><br />
                        <div id="tcb_3" style="display:none"><b><span id='tcb_3k'></span>:</b> <span id='tcb_3v'></span></div><br />
                        <div id="tcb_4" style="display:none"><b><span id='tcb_4k'></span>:</b> <span id='tcb_4v'></span></div><br />
                        <div id="tcb_5" style="display:none"><b><span id='tcb_5k'></span>:</b> <span id='tcb_5v'></span></div><br />
                        <div id="tcb_6" style="display:none"><b><span id='tcb_6k'></span>:</b> <span id='tcb_6v'></span></div><br />
                        <div id="tcb_7" style="display:none"><b><span id='tcb_7k'></span>:</b> <span id='tcb_7v'></span></div><br />
                        <div id="tcb_8" style="display:none"><b><span id='tcb_8k'></span>:</b> <span id='tcb_8v'></span></div><br />
                        <div id="tcb_9" style="display:none"><b><span id='tcb_9k'></span>:</b> <span id='tcb_9v'></span></div><br />
                    </p>

                </div>
                <!--Dynamic content-->

            </div>
        </div>
        <!--Header block-->
        <div id="header">
            <span id='header_1'>Niawa Notify - IPC Event Viewer</span>
        </div>
    </div>

    <!---------------------->
    <!--Script references -->
    <!---------------------->
    <!--Reference the jQuery library. -->
    <script src="Scripts/jquery-1.10.2.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="Scripts/jquery.signalR-2.0.2.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="signalr/hubs"></script>
    
    <!------------>
    <!--Scripts -->
    <!------------>
    <script type="text/javascript">
        //------------------------------------------------------
        //functions: public methods for SignalR hub
        //------------------------------------------------------

        var callerSessionID;

        $(function () {
            // Declare a proxy to reference the hub.
            var srHub = $.connection.niawaSRHub;

            //link up SignalR Hub functions with javascript functions in this file
            srHub.client.broadcastMessage = function (id, sender, message) { addRow(message); };

            srHub.client.addRow = function (message, callerSessionID) { addRow(message, callerSessionID); }
            srHub.client.removeRows = function (callerSessionID) { removeRows(callerSessionID); }
            srHub.client.populateStatusBlock = function (message, callerSessionID) { populateStatusBlock(message, callerSessionID); }
            srHub.client.treeViewRefresh = function (html, description, callerSessionID) { treeViewRefresh(html, description, callerSessionID); }
            srHub.client.treeViewNodeSelected = function (nodeID, callerSessionID) { treeViewNodeSelected(nodeID, callerSessionID); }
            srHub.client.pollSession = function (callerSessionID) { pollSession(callerSessionID); }
            srHub.client.sessionConnected = function (callerSessionID) { sessionConnected(callerSessionID); }
            srHub.client.sessionDisconnected = function (description, callerSessionID) { sessionDisconnected(description, callerSessionID); }

            //create a session ID
            createSessionID();

            // Start the connection
            $.connection.hub.start().done(function () {
                refreshTreeView(callerSessionID);
            });

            // request refresh
            sendCommand(1, "Refresh");

        });

        //--------------------------
        //script global variables
        //--------------------------
        var ix = 0;
        var alternatingLabelSwap = false;

        function sendCommand(ID, details) {
            try {
                var now = new Date().toLocaleString();
                var message = { Id: ID, ExplicitID: true, Sender: "web", CreatedDate: now, Message: details };
                $.ajax({
                    type: "POST",
                    data: JSON.stringify(message),
                    url: "api/Command",
                    contentType: "application/json"
                });

            }
            catch (e) {
                displayErrorMessage("Error in function sendCommand: " + e.message);
            }
        }

        //------------------------------------------------------
        //function: display a status message on the page
        //------------------------------------------------------
        function createSessionID() {
            try{
                callerSessionID = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }
            catch (e) {
                displayErrorMessage("Error in function createSessionID: " + e.message);
            }
        }

        //------------------------------------------------------
        //function: display a status message on the page
        //------------------------------------------------------
        function displayStatusMessage(message, ID) {
            try{
                //status message
                //$("#status_1").html(message);
                //setTimeout(function () { $("#status_1").html("&nbsp;") }, 3000);

                var nav3Block = document.getElementById('nav3');
                var statusBlock = document.createElement('span');
                statusBlock.id = "status";
                statusBlock.innerHTML = message + "<br>";
                nav3Block.appendChild(statusBlock);
                
                setTimeout(function () { $("#status").remove() }, 5000);
                //setTimeout($("#status").remove(), 3000);
                //$("div").remove(".contentblock");
            }
            catch (e) {
                displayErrorMessage("Error in function displayStatusMessage: " + e.message);
            }

        }

        //------------------------------------------------------
        //function: display an error message on the page
        //------------------------------------------------------
        function displayErrorMessage(message) {
            try {

                var nav3Block = document.getElementById('nav3');
                var statusBlock = document.createElement('span');
                statusBlock.style.color = "red";
                statusBlock.id = "statusError";
                statusBlock.innerHTML = "<b>Warning: " + message + "</b><br>";
                nav3Block.appendChild(statusBlock);

                setTimeout(function () { $("#statusError").remove() }, 60000);
            }
            catch (e) {
                alert("Error in function displayErrorMessage: " + e.message);
            }

        }

        //------------------------------------------------------
        //function: display an error message on the page
        //------------------------------------------------------
        function displayImportantMessage(message, ID) {
            try {

                var nav3Block = document.getElementById('nav3');
                var statusBlock = document.createElement('span');
                statusBlock.style.color = "purple";
                statusBlock.id = "statusImportant";
                statusBlock.innerHTML = "<b>" + message + "</b><br>";
                nav3Block.appendChild(statusBlock);

                setTimeout(function () { $("#statusImportant").remove() }, 15000);
            }
            catch (e) {
                displayErrorMessage("Error in function displayImportantMessage: " + e.message);
            }

        }

        //------------------------------------------------------
        //function: display a persistent message on the page
        //------------------------------------------------------
        function displayPersistentMessage(message, ID) {
            try {

                var nav3Block = document.getElementById('nav3');
                var statusBlock = document.createElement('span');
                statusBlock.style.color = "purple";
                statusBlock.id = ID;
                statusBlock.innerHTML = "<b>" + message + "</b><br>";
                nav3Block.appendChild(statusBlock);

            }
            catch (e) {
                displayErrorMessage("Error in function displayPersistentMessage: " + e.message);
            }
        }

        //------------------------------------------------------
        //function: clear a persistent message on the page
        //------------------------------------------------------
        function clearPersistentMessage(ID) {
            try {

                $("#" + ID).remove()
            }
            catch (e) {
                displayErrorMessage("Error in function clearPersistentMessage: " + e.message);
            }
        }

        //------------------------------------------------------
        //function: alternates between left and right div types
        //------------------------------------------------------
        function getAlternatingContentLabel() {
            try {

                if (alternatingLabelSwap == false) {
                    alternatingLabelSwap = true;
                    return "contentleft";
                }
                else {
                    alternatingLabelSwap = false;
                    return "contentright";
                }
            }
            catch (e) {
                displayErrorMessage("Error in function getAlternatingContentLabel: " + e.message);
            }

        }

        //------------------------------------------------------
        //function: show or hide div
        //------------------------------------------------------
        function showDiv(ix) {
            try {

                //show or hide div depending on current state
                var div = document.getElementById(ix);
                div.style.display = div.style.display == 'none' ? 'block' : 'none';
            }
            catch (e) {
                displayErrorMessage("Error in function showDiv: " + e.message);
            }

        }

        //------------------------------------------------------
        //function: clear the Status block 
        //------------------------------------------------------
        function clearStatusBlock() {
            try {
                displayStatusMessage("Clearing IPC status values", "clearStatusBlock");

                document.getElementById('tcb_1').style.display = 'none';
                document.getElementById('tcb_2').style.display = 'none';
                document.getElementById('tcb_3').style.display = 'none';
                document.getElementById('tcb_4').style.display = 'none';
                document.getElementById('tcb_5').style.display = 'none';
                document.getElementById('tcb_6').style.display = 'none';
                document.getElementById('tcb_7').style.display = 'none';
                document.getElementById('tcb_8').style.display = 'none';
                document.getElementById('tcb_9').style.display = 'none';

                $("#tsb_ThreadName").text("");
                $("#header_1").text("IPC Event Viewer []");
                $("#tsb_NodeID").text("");
                $("#tsb_ParentNodeID").text("");
                $("#tsb_ThreadStatus").text("");
                $("#tsb_LastReportedDate").text("");
                $("#tsb_InitializedDate").text("");
                $("#tsb_ThreadHealth").text("");
                $("#tsb_ErrorCount").text("");
                $("#tsb_MessagesProcessedCount").text("");
                $("#tsb_MessageErrorsCount").text("");

            }
            catch (e) {
                displayErrorMessage("Error in function clearStatusBlock: " + e.message);
            }
        }

        //------------------------------------------------------
        //function: select the node at the server
        //signalR out
        //------------------------------------------------------
        function selectNode(nodeID) {
            try {
                displayStatusMessage("Selecting node " + nodeID, "selectNode");

                // Declare a proxy to reference the hub.
                var srHubOut = $.connection.niawaSRHub;

                srHubOut.server.selectNode(nodeID, callerSessionID);
            }
            catch (e) {
                displayErrorMessage("Error in function selectNode: " + e.message);
            }
        }

        //------------------------------------------------------
        //function: refresh the tree view - get from the server
        //signalR out
        //------------------------------------------------------
        function refreshTreeView() {
            try {
                displayStatusMessage("Refreshing tree view", "refreshTreeView");

                // Declare a proxy to reference the hub.
                var srHubOut = $.connection.niawaSRHub;
                srHubOut.server.refreshTreeView(callerSessionID);
            }
            catch (e) {
                displayErrorMessage("Error in function refreshTreeView: " + e.message);
            }

        }

        //------------------------------------------------------
        //function: server polls the session (which responds)
        //signalR in; signalR out
        //------------------------------------------------------
        function pollSession(callerSessionID) {
            try {
                displayStatusMessage("Server polling session", "pollSession");

                // Declare a proxy to reference the hub.
                var srHubOut = $.connection.niawaSRHub;
                srHubOut.server.pollSessionClient(callerSessionID);
            }
            catch (e) {
                displayErrorMessage("Error in function pollSession: " + e.message);
            }
        }

        //------------------------------------------------------
        //function: server connects the session
        //signalR in
        //------------------------------------------------------
        function sessionConnected(callerSessionID) {
            try {
                displayImportantMessage("Connected to server", "sessionConnected");
                clearPersistentMessage("sessionDisconnected");
            }
            catch (e) {
                displayErrorMessage("Error in function sessionConnected: " + e.message);
            }
        }

        //------------------------------------------------------
        //function: server connects the session
        //signalR in
        //------------------------------------------------------
        function sessionDisconnected(description, callerSessionID) {
            try {
                displayPersistentMessage("Disconnected from server (" + description + ")", "sessionDisconnected");

            }
            catch (e) {
                displayErrorMessage("Error in function sessionDisconnected: " + e.message);
            }
        }

        //------------------------------------------------------
        //function: add an IPC message to the HTML page
        //signalR in
        //------------------------------------------------------
        function addRow(rowValue, callerSessionID) {
            try {
                displayStatusMessage("Displaying IPC content", "addRow");

                var contentDivSwap = false;

                var mainDiv = document.getElementById('maincontent');
                var innerDiv = document.createElement('div');
                innerDiv.className = 'contentblock';
                mainDiv.appendChild(innerDiv);

                var obj = jQuery.parseJSON(rowValue);

                //reset swap indicator
                alternatingLabelSwap = false;

                //set values into specially-formatted divs for EventMessageDetail, EventType, and EventMessage elements
                for (var k in obj) {

                    //set EventMessageDetail into a hidden div
                    if (k == "EventMessageDetail") {
                        ix = ix + 1;

                        var contentDiv = document.createElement('div');
                        //contentDiv.className = 'contentleft';
                        contentDiv.className = getAlternatingContentLabel();
                        innerDiv.appendChild(contentDiv);

                        contentDiv.innerHTML = "<b><a href=\"javascript:void(0);\" onclick=\"showDiv(" + ix + ")\">" + k + " (...)</a></b>" + "<div id=\"" + ix + "\" style=\"display:none\">" + obj[k] + "</div>";
                    }

                        //set EventType into a large-font div
                    else if (k == "EventType") {
                        ix = ix + 1;

                        var contentDiv = document.createElement('div');
                        //contentDiv.className = 'contentleft';
                        contentDiv.className = getAlternatingContentLabel();
                        innerDiv.appendChild(contentDiv);

                        contentDiv.innerHTML = "<span style=\"font-size:16px\"><b>" + k + ": </b>" + obj[k] + "</span>";
                    }

                        //set EventMessage into a large-font div
                    else if (k == "EventMessage") {
                        ix = ix + 1;

                        var contentDiv = document.createElement('div');
                        //contentDiv.className = 'contentleft';
                        contentDiv.className = getAlternatingContentLabel();
                        innerDiv.appendChild(contentDiv);

                        contentDiv.innerHTML = "<span style=\"font-size:16px\"><b>" + k + ": </b>" + obj[k] + "</span>";
                    }
                    else {
                        //unknown content
                        //contentDiv.innerHTML = "<b>" + k + ": </b>" + obj[k];
                    } //~else k
                } //~for k

                //set values into standard divs for all other elements (except EventMessageDetail, EventType, and EventMessage)
                for (var k in obj) {

                    if (k == "EventMessageDetail") {; } //no action
                    else if (k == "EventType") {; } //no action
                    else if (k == "EventMessage") {; } //no action
                    else {
                        ix = ix + 1;

                        var contentDiv = document.createElement('div');
                        //contentDiv.className = 'contentleft';
                        contentDiv.className = getAlternatingContentLabel();
                        innerDiv.appendChild(contentDiv);

                        contentDiv.innerHTML = "<b>" + k + ": </b>" + obj[k];
                    } //~if k
                } //~for k

            }
            catch (e) {
                displayErrorMessage("Error in function addRow: " + e.message);
            }

            
        } //~addRow

        //------------------------------------------------------
        //function: remove all IPC messages from the HTML page
        //signalR in
        //------------------------------------------------------
        function removeRows(callerSessionID) {
            try {
                displayStatusMessage("Clearing IPC content", "removeRows");

                $("div").remove(".contentblock");

                clearStatusBlock();

            }
            catch (e) {
                displayErrorMessage("Error in function removeRows: " + e.message);
            }

        }

        //------------------------------------------------------
        //function: update the Status block with info from 
        //an IPC status message 
        //signalR in
        //------------------------------------------------------
        function populateStatusBlock(jsonString, callerSessionID) {
            try {
                displayStatusMessage("Displaying IPC status values", "populateStatusBlock");

                /***********************
                 json root
                 ***********************/
                var obj = jQuery.parseJSON(jsonString);

                //get values from EventMessageDetail element
                for (var k in obj) {

                    switch (k) {
                        case "EventID": break; //no action
                        case "EventDate": break; //no action
                        case "ApplicationName": break; //no action
                        case "ApplicationInstance": break; //no action
                        case "NodeID": break; //no action
                        case "ParentNodeID": break; //no action
                        case "EventType": break; //no action
                        case "EventMessage": break; //no action
                        case "EventMessageDetail":
                            /***********************
                             json event message detail
                             ***********************/
                            var obj2 = jQuery.parseJSON(obj[k]);

                            //hide tcb objects by default
                            document.getElementById('tcb_1').style.display = 'none';
                            document.getElementById('tcb_2').style.display = 'none';
                            document.getElementById('tcb_3').style.display = 'none';
                            document.getElementById('tcb_4').style.display = 'none';
                            document.getElementById('tcb_5').style.display = 'none';
                            document.getElementById('tcb_6').style.display = 'none';
                            document.getElementById('tcb_7').style.display = 'none';
                            document.getElementById('tcb_8').style.display = 'none';
                            document.getElementById('tcb_9').style.display = 'none';

                            var ix2 = 0;

                            //set and show tcb objects for each EventMessageDetail element (up to 9)
                            for (var k2 in obj2) {
                                if (k2.substring(0, 4) == "str:") {
                                    ix2++;
                                    switch (ix2) {
                                        case 1:
                                            $("#tcb_1k").text(k2);
                                            $("#tcb_1v").text(obj2[k2]);
                                            document.getElementById('tcb_1').style.display = 'block';
                                            break;
                                        case 2:
                                            $("#tcb_2k").text(k2);
                                            $("#tcb_2v").text(obj2[k2]);
                                            document.getElementById('tcb_2').style.display = 'block';
                                            break;
                                        case 3:
                                            $("#tcb_3k").text(k2);
                                            $("#tcb_3v").text(obj2[k2]);
                                            document.getElementById('tcb_3').style.display = 'block';
                                            break;
                                        case 4:
                                            $("#tcb_4k").text(k2);
                                            $("#tcb_4v").text(obj2[k2]);
                                            document.getElementById('tcb_4').style.display = 'block';
                                            break;
                                        case 5:
                                            $("#tcb_5k").text(k2);
                                            $("#tcb_5v").text(obj2[k2]);
                                            document.getElementById('tcb_5').style.display = 'block';
                                            break;
                                        case 6:
                                            $("#tcb_6k").text(k2);
                                            $("#tcb_6v").text(obj2[k2]);
                                            document.getElementById('tcb_6').style.display = 'block';
                                            break;
                                        case 7:
                                            $("#tcb_7k").text(k2);
                                            $("#tcb_7v").text(obj2[k2]);
                                            document.getElementById('tcb_7').style.display = 'block';
                                            break;
                                        case 8:
                                            $("#tcb_8k").text(k2);
                                            $("#tcb_8v").text(obj2[k2]);
                                            document.getElementById('tcb_8').style.display = 'block';
                                            break;
                                        case 9:
                                            $("#tcb_9k").text(k2);
                                            $("#tcb_9v").text(obj2[k2]);
                                            document.getElementById('tcb_9').style.display = 'block';
                                            break;
                                        default:
                                            break;
                                    } //~switch ix2
                                } //~if k2
                            } //~for k2

                            //set tsb objects for ThreadStatus element
                            for (var k2 in obj2) {

                                switch (k2) {
                                    case "ParentThreadID": break; //no action
                                    case "ThreadID": break; //no action
                                    case "ThreadStatus":
                                        /***********************
                                         json thread status
                                         ***********************/
                                        var obj3 = jQuery.parseJSON(obj2[k2]);

                                        for (var k3 in obj3) {

                                            switch (k3) {
                                                case "Description":
                                                    $("#tsb_ThreadName").text(obj3[k3]);
                                                    $("#header_1").text("IPC Event Viewer [" + obj3[k3] + "]");
                                                    break;
                                                case "NodeID":
                                                    $("#tsb_NodeID").text(obj3[k3]);
                                                    break;
                                                case "ParentNodeID":
                                                    $("#tsb_ParentNodeID").text(obj3[k3]);
                                                    break;
                                                case "Status":
                                                    $("#tsb_ThreadStatus").text(obj3[k3]);
                                                    break;
                                                case "StatusDate":
                                                    $("#tsb_LastReportedDate").text(obj3[k3]);
                                                    break;
                                                case "Initialized": break; //no action
                                                case "InitializedDate":
                                                    $("#tsb_InitializedDate").text(obj3[k3]);
                                                    break;
                                                case "Finalized": break; //no action
                                                case "FinalizedDate": break; //no action
                                                case "ThreadHealthFailed":
                                                    $("#tsb_ThreadHealth").text(obj3[k3]);
                                                    break;
                                                case "ThreadHealthDate": break; //no action
                                                case "ThreadActive": break; //no action
                                                case "ThreadEnabled": break; //no action
                                                case "ErrorCount":
                                                    $("#tsb_ErrorCount").text(obj3[k3]);
                                                    break;
                                                case "MessageCount":
                                                    $("#tsb_MessagesProcessedCount").text(obj3[k3]);
                                                    break;
                                                case "MessageErrorCount":
                                                    $("#tsb_MessageErrorsCount").text(obj3[k3]);
                                                    break;
                                                case "LastErrorDate": break; //no action
                                                case "LastMessageDate": break; //no action
                                                case "LastMessageErrorDate": break; //no action
                                                default:
                                                    //json ThreadStatus kvp not recognized
                                            } //~switch k3

                                        } //~for k3

                                        break;
                                    default:
                                        //json EventMessageDetail kvp not recognized
                                } //~switch k2
                            } //~for k2
                            break;

                        default:
                            //json root kvp not recognized
                    } //~switch k

                } //~for k

            }
            catch (e) {
                displayErrorMessage("Error in function populateStatusBlock: " + e.message);
            }


        } //~populateStatusBlock

        //------------------------------------------------------
        //function: Refresh the tree view
        //signalR in
        //------------------------------------------------------
        function treeViewRefresh(html, description, callerSessionID) {
            try {

                displayStatusMessage("Tree view refreshed (" + description + ")", "treeViewRefresh");

                //empty nav2's current content
                $('#nav2').empty();

                //get nav2
                var nav2 = document.getElementById('nav2');
                nav2.innerHTML = html;
                //alert(html);
            }
            catch (e) {
                displayErrorMessage("Error in function treeViewRefresh: " + e.message);
            }

        }

        //------------------------------------------------------
        //function: select a tree node
        //signalR in
        //------------------------------------------------------
        function treeViewNodeSelected(nodeID, callerSessionID) {
            try {
                displayStatusMessage("Node " + nodeID + " selected", "treeViewNodeSelected");
                
                var div = document.getElementById("li:" + nodeID);

                $("#CurrentNodeListItem").text(div.innerText);
            }
            catch (e) {
                displayErrorMessage("Error in function treeViewNodeSelected: " + e.message);
            }

        }


    </script>

</body>
</html>